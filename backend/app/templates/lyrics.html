<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Personalify - Lyrics Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', path='lyrics.css') }}">
    <link rel="icon" href="{{ url_for('static', path='Spotify_Primary_Logo_RGB_White.ico') }}" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet">
</head>
<body>

<header>
    <h1>Lyrics Analyzer</h1>
    <p class="subtitle">Paste any song lyrics below to uncover their emotional shades.</p>
</header>

<div class="container" id="dashboard">
    <div class="section">
        <form id="lyricsForm" class="lyrics-form">
            <textarea id="lyricsInput" name="lyrics" required placeholder="Write or paste your lyrics here... (English only)"></textarea>
        </form>

        <div class="analysis-controls">
            <h2 id="analysisResultTitle">Analysis Result</h2>
            <button id="analyzeButton" type="button" class="button-primary">Analyze Emotions</button>
        </div>
        <div id="results-section" style="display: none;">
            <div id="resultOutput">
                </div>
        </div>
    </div>
</div>

<footer>
    <a href="/" class="footer-link">Personalify</a>
    <span> © 2025 • Powered by </span>
    <a href="https://developer.spotify.com/" target="_blank" class="footer-link">Spotify API</a>
    <br>
    <a href="{% if spotify_id %}/dashboard/{{ spotify_id }}?time_range=short_term{% else %}/{% endif %}" class="footer-link">Back to Home</a>
    <span> • </span>
    <span>Created by </span>
    <a href="https://desty.page/anggars" target="_blank" class="footer-link">アリツ</a>
</footer>

<script>
    const form = document.getElementById('lyricsForm');
    const analyzeButton = document.getElementById('analyzeButton');
    const lyricsInput = document.getElementById('lyricsInput');
    const resultDiv = document.getElementById('resultOutput');
    const resultsSection = document.getElementById('results-section');
    const analysisResultTitle = document.getElementById('analysisResultTitle');

    // Hubungkan tombol ke form submit secara manual
    analyzeButton.addEventListener('click', function() {
        form.requestSubmit(); // Ini cara modern untuk submit form dari tombol luar
    });

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        resultsSection.style.display = 'block';
        analysisResultTitle.style.display = 'block'; // Tampilkan judul saat loading
        resultDiv.innerHTML = `
            <div class="loading-spinner"></div>
            <p class="emotion-recap" style="text-align: center;">Analyzing...</p>
        `;
        
        const lyrics = lyricsInput.value;

        try {
            const res = await fetch('/analyze-lyrics', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lyrics: lyrics})
            });

            if (!res.ok) {
                throw new Error(`Server error: ${res.statusText}`);
            }

            const data = await res.json();

            if (data.error) {
                resultDiv.innerHTML = `<p class="emotion-recap" style="color:#ff6b6b;">${data.error}</p>`;
            } else if (data.emotions && data.emotions.length > 0) {
                const topEmotions = data.emotions.filter(e => e.score > 0.05).slice(0, 10);

                if (topEmotions.length === 0) {
                     resultDiv.innerHTML = '<p class="emotion-recap">Could not find significant emotions in the provided text.</p>';
                     return;
                }
                
                const maxScore = Math.max(...topEmotions.map(e => e.score));

                resultDiv.innerHTML = topEmotions.map(e => `
                    <div class="emotion-bar-row">
                        <span class="emotion-label">${e.label}</span>
                        <div class="emotion-bar-bg">
                            <div class="emotion-bar" style="width:${(e.score / maxScore * 100).toFixed(1)}%"></div>
                        </div>
                        <span class="emotion-score">${e.score.toFixed(3)}</span>
                    </div>
                `).join('');
            } else {
                resultDiv.innerHTML = '<p class="emotion-recap">Could not determine emotions from the provided text.</p>';
            }
        } catch (err) {
            console.error("Fetch error:", err);
            resultDiv.innerHTML = '<p class="emotion-recap" style="color:#ff6b6b;">Failed to contact the analysis server. Please try again later.</p>';
        }
    });
</script>

</body>
</html>