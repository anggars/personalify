<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Personalify Dashboard</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', path='favicon.ico') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: #ffffff;
            padding: 1.5rem;
        }

        h1 {
            color: #1DB954;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 3rem;
        }

        /* --- PERBAIKAN DROPDOWN --- */
        .select-wrapper {
            position: relative;
            display: inline-block;
            border-radius: 9999px;
        }

        .select-wrapper::after {
            content: '▼';
            font-size: 0.8rem;
            color: #aaa;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .filters select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: #2a2a2a; /* <-- KEMBALIKAN BACKGROUND */
            border: none;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            font-size: 1rem;
            color: #ffffff;
            cursor: pointer;
            border-radius: 9999px; /* <-- PINDAHKAN KE SINI */
        }

        .filters select option {
            background: #2a2a2a;
            color: #ffffff;
        }
        /* --- AKHIR PERBAIKAN DROPDOWN --- */


        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .section {
            background: #1e1e1e;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .section:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.5);
        }

        .section h2 {
            position: relative;
            height: 60px;
            line-height: 25px;
            text-align: center;
            font-size: 1.25rem;
            color: #1DB954;
            border-bottom: 1px solid #333;
            margin-bottom: 1rem;
            padding: 0;
        }

        /* --- PERBAIKAN LAYOUT LIST --- */
        .artist, .track, .genre {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .artist, .track {
            min-height: 64px; /* Menjaga tinggi konsisten */
        }
        
        .genre {
            gap: 0; /* Genre tidak punya gambar, jadi tidak perlu gap */
        }

        .artist img, .track img {
            width: 64px;
            height: 64px;
            border-radius: 0.5rem;
            object-fit: cover;
            flex-shrink: 0; /* Mencegah gambar menyusut */
        }

        .info {
            flex: 1;
            min-width: 0;
        }

        .info .name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            overflow-wrap: break-word;
        }
        /* --- AKHIR PERBAIKAN LAYOUT LIST --- */

        .info .meta {
            font-size: 0.8rem;
            color: #bbb;
        }

        .genre-label {
            display: inline-block;
            background-color: #1DB954;
            color: black;
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
            border-radius: 9999px;
            margin: 0.1rem 0.2rem 0 0;
        }

        .more-genres {
            display: none;
        }

        .show-more {
            cursor: pointer;
            color: #1DB954;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            display: inline-block;
        }

        @media (max-width: 768px) {
            .section {
                display: none;
            }
            .section.active {
                display: block;
            }
        }
        
        @media (min-width: 769px) {
            #category-filter-wrapper { /* Pastikan wrapper disembunyikan di desktop */
                display: none !important;
            }
        }

        .download-btn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 0.75rem 1.25rem;
            background-color: #1DB954;
            color: black;
            border: none;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        footer {
            margin-top: 3rem;
            text-align: center;
            font-size: 0.75rem;
            color: #888;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: #2a2a2a;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 90%;
            width: 400px;
        }

        .modal-content h3 {
            margin-top: 0;
            color: #1DB954;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-options button {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border-radius: 9999px;
            border: none;
            background-color: #1DB954;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .modal-options button:hover {
            background-color: #1ed760;
        }

        .modal-close {
            margin-top: 1.5rem;
            background: none;
            border: 1px solid #555;
            color: #aaa;
        }
        .modal-close:hover {
            background-color: #333;
            color: #fff;
        }
    </style>
</head>
<body>
    <h1>Welcome, {{ user }}!</h1>

    <div class="filters">
        <div class="select-wrapper">
            <select id="time-filter">
                <option value="short_term" {% if time_range == 'short_term' %}selected{% endif %}>Last Month</option>
                <option value="medium_term" {% if time_range == 'medium_term' %}selected{% endif %}>6 Months</option>
                <option value="long_term" {% if time_range == 'long_term' %}selected{% endif %}>Last Year</option>
            </select>
        </div>

        <div class="select-wrapper" id="category-filter-wrapper" style="display:none;">
            <select id="category-filter">
                <option value="artists" {% if category == 'artists' %}selected{% endif %}>Top Artists</option>
                <option value="tracks" {% if category == 'tracks' %}selected{% endif %}>Top Tracks</option>
                <option value="genres" {% if category == 'genres' %}selected{% endif %}>Top Genres</option>
            </select>
        </div>
    </div>

    <div class="container" id="dashboard">
        <div class="section" id="artists-section">
            <h2>Top Artists</h2>
            {% for artist in artists %}
            <div class="artist">
                <img src="{{ artist.image }}" alt="{{ artist.name }}">
                <div class="info">
                    <div class="name">{{ artist.name }}</div>
                    <div class="meta">
                        {% set max_genres = 5 %}
                        {% for genre in artist.genres[:max_genres] %}<span class="genre-label">{{ genre }}</span>{% endfor %}
                        {% if artist.genres | length > max_genres %}
                        <span class="more-genres" id="more-{{ loop.index }}">
                            {% for genre in artist.genres[max_genres:] %}<span class="genre-label">{{ genre }}</span>{% endfor %}
                        </span>
                        <span class="show-more" onclick="toggleMore({{ loop.index }}, this)">+ more</span>
                        {% endif %}
                    </div>
                    <div class="meta">Popularity: {{ artist.popularity }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="section" id="tracks-section">
            <h2>Top Tracks</h2>
            {% for track in tracks %}
            <div class="track">
                <img src="{{ track.image }}" alt="{{ track.name }}">
                <div class="info">
                    <div class="name">{{ track.name }}</div>
                    <div class="meta">Artist(s): {{ track.artists | join(', ') }}</div>
                    <div class="meta">Album: {{ track.album }}</div>
                    <div class="meta">Popularity: {{ track.popularity }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="section" id="genres-section">
            <h2>Top Genres</h2>
            <canvas id="genreChart" style="max-height:300px;margin:1rem 0 2rem 0;"></canvas>
            {% for genre in genres %}
            <div class="genre">
                <div class="info">
                    <div class="name">{{ genre.name }}</div>
                    <div class="meta">Count: {{ genre.count }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <button class="download-btn" onclick="showSaveOptions()">Save as Image</button>

    <div id="save-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3>Choose Category to Save</h3>
            <div class="modal-options">
                <button id="save-artists-btn">Top Artists</button>
                <button id="save-tracks-btn">Top Tracks</button>
                <button id="save-genres-btn">Top Genres</button>
                <button class="modal-close" onclick="hideSaveOptions()">Cancel</button>
            </div>
        </div>
    </div>

    <footer>
        Personalify © 2025 • Powered by Spotify API
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
        // --- PERBAIKAN JAVASCRIPT ---
        const categoryFilterSelect = document.getElementById("category-filter");
        const categoryFilterWrapper = document.getElementById("category-filter-wrapper");
        const sections = {
            artists: document.getElementById("artists-section"),
            tracks: document.getElementById("tracks-section"),
            genres: document.getElementById("genres-section")
        };
        const modal = document.getElementById("save-modal-overlay");

        function updateCategoryDisplay() {
            const value = categoryFilterSelect.value;
            for (const key in sections) {
                sections[key].classList.remove("active");
            }
            if (sections[value]) {
                sections[value].classList.add("active");
            }
        }

        categoryFilterSelect.addEventListener("change", updateCategoryDisplay);

        function checkScreenSize() {
            if (window.innerWidth <= 768) {
                categoryFilterWrapper.style.display = "inline-block";
                updateCategoryDisplay();
            } else {
                for (const key in sections) {
                    sections[key].style.display = "block";
                    sections[key].classList.remove("active");
                }
                categoryFilterWrapper.style.display = "none";
            }
        }
        // --- AKHIR PERBAIKAN JAVASCRIPT ---

        window.addEventListener("resize", checkScreenSize);
        document.addEventListener("DOMContentLoaded", checkScreenSize);

        document.getElementById("time-filter").addEventListener("change", function() {
            const selected = this.value;
            const currentURL = window.location.href.split('?')[0].split('#')[0];
            const userId = currentURL.split('/').pop();
            window.location.href = `/dashboard/${userId}?time_range=${selected}`;
        });

        function toggleMore(index, el) {
            const more = document.getElementById("more-" + index);
            const isVisible = more.style.display === "inline";
            more.style.display = isVisible ? "none" : "inline";
            el.textContent = isVisible ? "+ more" : "− less";
        }
        
        function showSaveOptions() {
            modal.style.display = 'flex';
        }

        function hideSaveOptions() {
            modal.style.display = 'none';
        }

        function generateImage(selectedCategory) {
            hideSaveOptions();
            
            const timeText = document.querySelector('#time-filter option:checked').textContent;
            const username = document.querySelector('h1').innerText;

            for (const key in sections) {
                sections[key].style.display = "none";
            }

            const sectionToCapture = sections[selectedCategory];
            sectionToCapture.style.display = "block";

            const clone = sectionToCapture.cloneNode(true);

            if (selectedCategory === 'genres') {
                const originalCanvas = document.getElementById('genreChart');
                const clonedCanvas = clone.querySelector('#genreChart');

                if (originalCanvas && clonedCanvas) {
                    const chartImage = new Image();
                    chartImage.src = originalCanvas.toDataURL('image/png');
                    
                    chartImage.style.width = '100%';
                    chartImage.style.height = 'auto';
                    chartImage.style.display = 'block';
                    chartImage.style.margin = clonedCanvas.style.margin;

                    clonedCanvas.parentNode.replaceChild(chartImage, clonedCanvas);
                }
            }

            const container = document.createElement("div");
            container.style.width = "720px";
            container.style.background = "#121212";
            container.style.padding = "1.5rem";
            container.style.boxSizing = "border-box";
            container.style.color = "#fff";
            container.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";

            const title = document.createElement("h1");
            title.innerText = "Personalify";
            title.style.textAlign = "center";
            title.style.color = "#1DB954";
            title.style.marginBottom = "1rem";
            container.appendChild(title);

            const welcome = document.createElement("h2");
            welcome.innerText = username;
            welcome.style.textAlign = "center";
            welcome.style.fontSize = "1rem";
            welcome.style.color = "#ccc";
            welcome.style.marginBottom = "0.75rem";
            container.appendChild(welcome);

            const timeLabel = document.createElement("div");
            timeLabel.innerText = timeText;
            timeLabel.style.textAlign = "center";
            timeLabel.style.fontSize = "0.9rem";
            timeLabel.style.color = "#aaa";
            timeLabel.style.marginBottom = "1rem";
            container.appendChild(timeLabel);

            container.appendChild(clone);

            const footer = document.createElement("div");
            footer.innerText = "Personalify © 2025 • Powered by Spotify API";
            footer.style.marginTop = "2rem";
            footer.style.fontSize = "0.75rem";
            footer.style.color = "#888";
            footer.style.textAlign = "center";
            container.appendChild(footer);

            function renderCanvas() {
                document.body.appendChild(container);
                html2canvas(container, {
                    backgroundColor: null,
                    scale: 2,
                    useCORS: true
                }).then(canvas => {
                    const link = document.createElement("a");
                    link.download = `personalify-${selectedCategory}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    document.body.removeChild(container);
                    checkScreenSize();
                });
            }

            const imgs = clone.querySelectorAll('img');
            if (imgs.length === 0) {
                renderCanvas();
            } else {
                let loadedCount = 0;
                imgs.forEach(img => {
                    const tempImg = new Image();
                    tempImg.crossOrigin = "anonymous";
                    tempImg.src = img.src;
                    tempImg.onload = () => {
                        loadedCount++;
                        if (loadedCount === imgs.length) renderCanvas();
                    };
                    tempImg.onerror = () => {
                        loadedCount++;
                        if (loadedCount === imgs.length) renderCanvas();
                    };
                });
            }
        }
        
        document.getElementById('save-artists-btn').addEventListener('click', () => generateImage('artists'));
        document.getElementById('save-tracks-btn').addEventListener('click', () => generateImage('tracks'));
        document.getElementById('save-genres-btn').addEventListener('click', () => generateImage('genres'));

        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                hideSaveOptions();
            }
        });

        window.onload = function() {
            const ctx = document.getElementById('genreChart');
            if (ctx) {
                
                // --- PLUGIN BARU UNTUK MEMBERI JARAK ---
                const legendMarginPlugin = {
                    id: 'legendMargin',
                    beforeInit(chart, args, options) {
                        if (chart.legend.options.position === 'top') {
                            const originalFit = chart.legend.fit;
                            chart.legend.fit = function() {
                                originalFit.bind(chart.legend)();
                                this.height += 25; // Menambah 25px ruang di bawah legend
                            }
                        }
                    }
                };
                // --- AKHIR PLUGIN ---

                const data = {
                    labels: [{% for genre in genres %}'{{ genre.name }}'{% if not loop.last %},{% endif %}{% endfor %}],
                    datasets: [{
                        data: [{% for genre in genres %}{{ genre.count }}{% if not loop.last %},{% endif %}{% endfor %}],
                        backgroundColor: [
                            '#1DB954', '#F28E2B', '#E15759', '#76B7B2', '#59A14F',
                            '#EDC948', '#B07AA1', '#FF9DA7', '#9C755F', '#BAB0AC'
                        ]
                    }]
                };

                new Chart(ctx, {
                    type: 'pie',
                    data: data,
                    // Daftarkan plugin di sini
                    plugins: [legendMarginPlugin],
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top', // Pastikan posisi legend di atas
                                labels: {
                                    color: '#fff',
                                    padding: 10
                                }
                            }
                        }
                    }
                });
            }
            checkScreenSize();
        };
    </script>
</body>
</html>